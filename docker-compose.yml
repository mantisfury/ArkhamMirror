# =============================================================================
# SHATTERED KANDOR: Docker Compose
# Works for both local development and VPS deployment
#
# Usage:
#   docker compose up -d              # Start all services
#   docker compose logs -f app        # View app logs
#   docker compose down                # Stop all services
#   docker compose down -v             # Stop and remove volumes (DELETES DATA)
# =============================================================================

name: shattered

services:
  # ---------------------------------------------------------------------------
  # Main Application (Frame + Shards + Shell UI)
  # ---------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: shattered:local
    container_name: shattered-app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8100}:8100"
    environment:
      # Database connection
      - DATABASE_URL=postgresql://${POSTGRES_USER:-arkham}:${POSTGRES_PASSWORD:-arkhampass}@postgres:5432/${POSTGRES_DB:-arkhamdb}
      # Vector store (optional)
      - QDRANT_URL=http://qdrant:6333
      # Job queue (optional)
      - REDIS_URL=redis://redis:6379
      # LLM endpoint (optional - works without it)
      - LLM_ENDPOINT=${LLM_ENDPOINT:-}
      - LM_STUDIO_URL=${LM_STUDIO_URL:-}
      - LLM_API_KEY=${LLM_API_KEY:-}
      # VLM endpoint for OCR shard (optional)
      - VLM_ENDPOINT=${VLM_ENDPOINT:-}
      # Serve the React shell from FastAPI
      - ARKHAM_SERVE_SHELL=true
    volumes:
      # Persist uploaded documents and exports
      - datasilo:/app/DataSilo
      # Optional: mount config file for shard selection
      - ./config/shattered.yaml:/app/config/shattered.yaml:ro
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - shattered-net
    # For connecting to LLM on host machine (LM Studio, Ollama, etc)
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: shattered-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-arkham}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-arkhampass}
      - POSTGRES_DB=${POSTGRES_DB:-arkhamdb}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-arkham} -d ${POSTGRES_DB:-arkhamdb}"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - shattered-net
    # Uncomment to expose PostgreSQL externally (for debugging)
    # ports:
    #   - "5432:5432"

  # ---------------------------------------------------------------------------
  # Qdrant Vector Database
  # ---------------------------------------------------------------------------
  qdrant:
    image: qdrant/qdrant:latest
    container_name: shattered-qdrant
    restart: unless-stopped
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      # Use bash /dev/tcp since curl/wget not available in Qdrant image
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/6333'"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - shattered-net
    # Uncomment to expose Qdrant externally (for debugging)
    # ports:
    #   - "6333:6333"

  # ---------------------------------------------------------------------------
  # Redis (Job Queue)
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: shattered-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - shattered-net
    # Uncomment to expose Redis externally (for debugging)
    # ports:
    #   - "6379:6379"

# -----------------------------------------------------------------------------
# Volumes (Persistent Data)
# -----------------------------------------------------------------------------
volumes:
  postgres_data:
    name: shattered_postgres_data
  qdrant_data:
    name: shattered_qdrant_data
  redis_data:
    name: shattered_redis_data
  datasilo:
    name: shattered_datasilo

# -----------------------------------------------------------------------------
# Network
# -----------------------------------------------------------------------------
networks:
  shattered-net:
    name: shattered-network
    driver: bridge
